# https://github.com/murray-mint/steamcache/
#
# This config file will configure a depot-caching proxy server for Steam
# content. For any event with more than one person in attendance, this will
# drastically reduce internet bandwidth consumption significantly - especially
# if someone releases a patch during your event!
#
# This configuration can also be useful for users who boot into multiple
# operating systems (e.g. dual booting Windows/Linux) as many games share
# depot chunks between platforms.
#
# Replace all instances of /srv/steamcache with any valid path you choose.
# It is HIGHLY recommended that the cache files be on a separate filesystem
# to the rest of your system, to ensure that it cannot fill the rootfs or
# other critical filesystems.
#
# You may also choose to change the log file paths. It's recommended for ease
# of monitoring that you choose a single file for all steamcache access log
# directives.
#
# nginx MUST have read and write permissions to this path, so make sure you
# configure carefully! If you're running Debian or Ubuntu, nginx runs as
# www-data:www-data by default, so run the following to correctly configure
# path permissions:
#
# chown -R www-data:www-data /srv/steamcache
# find /srv/steamcache -type d -exec chmod 775 '{}' ';'
# find /srv/steamcache -type f -exec chmod 664 '{}' ';'
#
# To view activity on your cache whilst it is in operation, run the following:
# tail -F /srv/steamcache/access.log
# Any line ending in REMOTE has been fetched from the internet. Any line
# ending in LOCAL has been served from the cache.
# Lines ending in OTHER are non-depot requests.
#
# Regular commodity hardware (a single 2TB WD Black on an HP Microserver) can
# achieve peak throughputs of 30MB/s+ using this setup (depending on the
# specific content being served).

log_format steamcache-default '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" DEFAULT';
log_format steamcache-other '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" OTHER';
log_format steamcache-local '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" LOCAL';
log_format steamcache-remote '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" REMOTE';

server {
	listen 80;
	server_name *.cs.steampowered.com content1.steampowered.com content2.steampowered.com content3.steampowered.com content4.steampowered.com content5.steampowered.com content6.steampowered.com content7.steampowered.com content8.steampowered.com;

	access_log /srv/steamcache/access.log steamcache-default;
	error_log /srv/steamcache/error.log;

	root /srv/steamcache/public_html/;
	index index.html;

	# Uncomment this line to proxy through steamcache.net.
	# This allows us to keep the online cache up-to-date for events
	# to rsync down to their own caches.

	# resolver 109.228.3.24;

	# As a bonus, this also allows you to configure a single route to
	# direct your Steam download traffic down an alternative network
	# interface (e.g. 3G modem, second DSL line) from your primary
	# internet connection.

	location /depot/ {
		try_files $uri @mirror;
		access_log /srv/steamcache/access.log steamcache-local;
	}

	location / {
		proxy_next_upstream error timeout http_404;

		proxy_pass http://$host$request_uri;
		proxy_redirect off;

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		add_header X-Mirror-Upstream-Status $upstream_status;
		add_header X-Mirror-Upstream-Response-Time $upstream_response_time;
		add_header X-Mirror-Status $upstream_cache_status;

		access_log /srv/steamcache/access.log steamcache-other;
	}

	location @mirror {
		proxy_store on;
		proxy_store_access user:rw group:rw all:r;
		proxy_next_upstream error timeout http_404;
		proxy_pass http://$host$request_uri;
		proxy_redirect off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		add_header X-Mirror-Upstream-Status $upstream_status;
		add_header X-Mirror-Upstream-Response-Time $upstream_response_time;
		add_header X-Mirror-Status $upstream_cache_status;

		access_log /srv/steamcache/access.log steamcache-remote;
	}
}

